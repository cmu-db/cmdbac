{% extends "base.html" %}
{% load staticfiles %}

{% block title %}
Repositories &raquo; Database Application Crawler
{% endblock %}

{% block main %}
{% include "status_codes.html" %}
{% include "add_module.html" %}
{% include "add_repository.html" %}

{% if messages %}
<div>
<ul class="messages">
    {% for message in messages %}
        {% if message.tags == 'success' %}
            <div class="alert alert-success" role="alert">{{message}}</div>
        {% endif %}
        {% if message.tags == 'error' %}
            <div class="alert alert-danger" role="alert">{{message}}</div>
        {% endif %}
    {% endfor %}
</ul>
{% endif %}

<h2 class="page-header">Repositories</h2>

<form action="{% url 'repositories' %}" method="get">
    <div style="float:left">
    {{ result_form }}
    </div>

    <div style="float:left">
    {{ type_form }}
    </div>

    <div style="float:left">
        <b>Name:</b>
        <input type="Search" placeholder='Search by full name' value='{{ search }}' class="form-control" name='search'/>
        <div style="margin: 20px">
            <input class="btn btn-primary btn-lg" type="submit" value="Filter"/>
        </div>
    </div>
</form>

<div style="float:right">
    <div style="margin: 20px">
        <a class="btn btn-primary btn-lg" style="" href="#" data-toggle="modal" data-target="#addModuleModal">Add Module</a>
    </div>

    <div style="margin: 20px">
        <a class="btn btn-primary btn-lg" style="" href="#" data-toggle="modal" data-target="#addRepositoryModal">Add Repository</a>
    </div>
</div>

<div class="table-responsive" style="clear:both;">
    <table class="table table-striped">
        <thead>
            <tr>
                <th><a href="?order_by={% if order_by == "name" %}-{% endif %}name&amp;{{ queries_no_page_order.urlencode }}">Full Name</th>
                <th>Source</th>
                <th><a href="?order_by={% if order_by == "repo_type__name" %}-{% endif %}repo_type__name&amp;{{ queries_no_page_order.urlencode }}">Type</th>
                <th><a href="?order_by={% if order_by != "-commits_count" %}-{% endif %}commits_count&amp;{{ queries_no_page_order.urlencode }}"># of Commits</th>
                <th><a href="?order_by={% if order_by != "-attempts_count" %}-{% endif %}attempts_count&;{{queries_no_page_order.urlencode }}"> # of Attempts</th>
                <th><a href="?order_by={% if order_by == "latest_attempt__result__name" %}-{% endif %}latest_attempt__result__name&amp;{{ queries_no_page_order.urlencode }}">Last Result</th>
                <th><a href="?order_by={% if order_by != "-updated_date" %}-{% endif %}updated_date&;{{queries_no_page_order.urlencode }}">Updated</th>
            </tr>
        </thead>
        <tbody>
            {% if repositories %}
                {% for repository in repositories %}
                <tr>
                    <td><a id="{{ repository.name}}" href="{% url 'repository' repository.user_name repository.repo_name %}?{{ queries.urlencode }}">{{repository.name}}</a></td>
                    
                    <td><a href="{{ repository.repo_url }}"><img src="{% static repository.source.logo %}" alt="{{ repository.source.name }}" title="View on {{ repository.source.name }}" class="source-logo" /></a></td>
                    
                    <td><img src="{% static repository.project_type.logo %}" alt="{{ repository.project_type.name }}" title="{{ repository.project_type.name }}" class="projecttype-logo" /></td>

                    <td>{{repository.commits_count}}</td>

                    <td>{{repository.attempts_count}}</td>

                    <td>
                    {% if not repository.latest_attempt %}
                        -
                    {% else %}
                        <a id="{{repository.latest_attempt.id}}" href="{% url 'attempt' repository.latest_attempt.id %}?{{ queries.urlencode }}" class="label label-{{ repository.latest_attempt.result_label }}">{{repository.latest_attempt.result_name}}</a>
                        <a href="#" data-toggle="modal" data-target="#statusModal">?</a>
                    {% endif %}
                    </td>
                    
                    <td>{{repository.updated_date|date:'Y-m-d H:i:s' }}</td>
                    
                    <td>
                        <div class="row">
                            <div class="col-xs-3">
                                <form action="{% url 'repositories' %}" method="get">
                                    <input type="hidden" value="{{repository.name}}" name="deploy"/>
                                    <label for="deploy{{repository.id}}" class="btn">
                                        <i class="glyphicon glyphicon-circle-arrow-down" title="deploy"></i>
                                    </label>
                                    <input id="deploy{{repository.id}}" class="hidden" type="submit"/> 
                                </form>
                                </div>

                                <div class="col-xs-3">
                                <form action="{% url 'repositories' %}" method="get">
                                    <input type="hidden" value="{{repository.name}}" name="delete"/>
                                    <label for="delete{{repository.id}}" class="btn">
                                        <i class="glyphicon glyphicon-trash" title="delete"></i>
                                    </label>
                                    <input id="delete{{repository.id}}" class="hidden" type="submit"/> 
                                </form>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% endif %}
        </tbody>
    </table>
</div>

<ul id="pagination-demo" class="pagination-sm"></ul>

<script type='text/javascript'>
    $('#pagination-demo').twbsPagination({
        totalPages: {{ repositories.paginator.num_pages }},
        visiblePages: 10,
        href: '?page={% templatetag openvariable %}number{% templatetag closevariable %}&{{ queries_no_page.urlencode }}',
        onPageClick: function (event, page) {
            $('#page-content').text('Page ' + page);
        }
    });
</script>

{% endblock %}
